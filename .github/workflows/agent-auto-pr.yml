name: Agent Auto PR

on:
  push:
    branches:
      - "docs/**"
      - "adr/**"
      - "research/**"
      - "chore/**"
      - "fix/**"
      - "agent/**"

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: write

jobs:
  open_pr_if_missing:
    runs-on: ubuntu-latest

    steps:
      - name: Create PR if missing
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = context.ref.replace('refs/heads/', '');
            const base = 'main';

            core.setOutput('branch', branch);

            // Don't auto-PR for main.
            if (branch === base) {
              core.info('Branch is main; skipping.');
              core.setOutput('pr_number', '');
              return;
            }

            // Ensure label exists.
            const labelName = 'automerge';
            try {
              await github.rest.issues.getLabel({ owner, repo, name: labelName });
            } catch (e) {
              if (e.status === 404) {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: labelName,
                  color: '0E8A16',
                  description: 'Agent-managed: merge automatically when required checks pass.'
                });
              } else {
                throw e;
              }
            }

            // Find existing open PR from this branch to main.
            const head = `${owner}:${branch}`;
            const prs = await github.rest.pulls.list({ owner, repo, state: 'open', head, base });

            if (prs.data.length > 0) {
              const n = prs.data[0].number;
              core.info(`Open PR already exists: #${n}`);
              core.setOutput('pr_number', String(n));
              return;
            }

            const title = `Agent PR: ${branch}`;
            const body = [
              'This PR was opened automatically by an agent workflow on branch push.',
              '',
              'Guardrails:',
              '- Planning-only until Stage 2 (see `docs/quality/STAGE_STATUS.md`)',
              '- Traceability required for material changes',
              '',
              'The CI checks in this repo act as the review/verification gate.'
            ].join('\n');

            const pr = await github.rest.pulls.create({ owner, repo, title, head: branch, base, body, draft: false });
            core.info(`Created PR #${pr.data.number}`);
            core.setOutput('pr_number', String(pr.data.number));

            // Apply automerge label (merge still gated by required checks).
            await github.rest.issues.addLabels({ owner, repo, issue_number: pr.data.number, labels: [labelName] });
            core.info('Applied automerge label.');

      - name: Dispatch required checks for PR head SHA
        if: ${{ steps.pr.outputs.pr_number != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = Number('${{ steps.pr.outputs.pr_number }}');
            const branch = '${{ steps.pr.outputs.branch }}';

            const pr = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
            const baseSha = pr.data.base.sha;
            const headSha = pr.data.head.sha;

            core.info(`Dispatching checks for PR #${prNumber}`);
            core.info(`  base: ${baseSha}`);
            core.info(`  head: ${headSha}`);

            // NOTE: PRs created by GITHUB_TOKEN may not trigger pull_request workflows.
            // We explicitly dispatch the check workflows on the PR branch ref so their
            // workflow_run events can drive auto-merge.
            const inputs = {
              base_sha: baseSha,
              head_sha: headSha,
              pr_number: String(prNumber),
            };

            const workflows = [
              'guardrails-planning-only.yml',
              'docs-ci.yml',
            ];

            for (const wf of workflows) {
              core.info(`Dispatching workflow: ${wf} (ref=${branch})`);
              await github.rest.actions.createWorkflowDispatch({
                owner,
                repo,
                workflow_id: wf,
                ref: branch,
                inputs,
              });
            }
