name: Agent Auto PR

on:
  push:
    branches:
      - "docs/**"
      - "adr/**"
      - "research/**"
      - "chore/**"
      - "fix/**"
      - "agent/**"

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  open_pr_if_missing:
    runs-on: ubuntu-latest

    steps:
      - name: Create PR if missing (try AGENT_GH_TOKEN)
        id: create_pr_primary
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AGENT_GH_TOKEN || github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = context.ref.replace('refs/heads/', '');
            const base = 'main';

            // Don't auto-PR for main.
            if (branch === base) {
              core.info('Branch is main; skipping.');
              return;
            }

            // Ensure label exists.
            const labelName = 'automerge';
            try {
              await github.rest.issues.getLabel({ owner, repo, name: labelName });
            } catch (e) {
              if (e.status === 404) {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: labelName,
                  color: '0E8A16',
                  description: 'Agent-managed: merge automatically when required checks pass.'
                });
              } else {
                throw e;
              }
            }

            // Find existing open PR from this branch to main.
            const head = `${owner}:${branch}`;
            const prs = await github.rest.pulls.list({ owner, repo, state: 'open', head, base });

            if (prs.data.length > 0) {
              core.info(`Open PR already exists: #${prs.data[0].number}`);
              return;
            }

            const title = `Agent PR: ${branch}`;
            const body = [
              'This PR was opened automatically by an agent workflow on branch push.',
              '',
              'Guardrails:',
              '- Planning-only until Stage 2 (see `docs/quality/STAGE_STATUS.md`)',
              '- Traceability required for material changes',
              '',
              'The CI checks in this repo act as the review/verification gate.'
            ].join('\n');

            const pr = await github.rest.pulls.create({ owner, repo, title, head: branch, base, body, draft: false });
            core.info(`Created PR #${pr.data.number}`);

            // Apply automerge label (merge still gated by required checks).
            await github.rest.issues.addLabels({ owner, repo, issue_number: pr.data.number, labels: [labelName] });
            core.info('Applied automerge label.');

      - name: Create PR if missing (fallback to GITHUB_TOKEN)
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = context.ref.replace('refs/heads/', '');
            const base = 'main';

            // Don't auto-PR for main.
            if (branch === base) {
              core.info('Branch is main; skipping.');
              return;
            }

            // Ensure label exists.
            const labelName = 'automerge';
            try {
              await github.rest.issues.getLabel({ owner, repo, name: labelName });
            } catch (e) {
              if (e.status === 404) {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: labelName,
                  color: '0E8A16',
                  description: 'Agent-managed: merge automatically when required checks pass.'
                });
              } else {
                throw e;
              }
            }

            // Find existing open PR from this branch to main.
            const head = `${owner}:${branch}`;
            const prs = await github.rest.pulls.list({ owner, repo, state: 'open', head, base });

            if (prs.data.length > 0) {
              core.info(`Open PR already exists: #${prs.data[0].number}`);
              return;
            }

            const title = `Agent PR: ${branch}`;
            const body = [
              'This PR was opened automatically by an agent workflow on branch push.',
              '',
              'Guardrails:',
              '- Planning-only until Stage 2 (see `docs/quality/STAGE_STATUS.md`)',
              '- Traceability required for material changes',
              '',
              'The CI checks in this repo act as the review/verification gate.'
            ].join('\n');

            const pr = await github.rest.pulls.create({ owner, repo, title, head: branch, base, body, draft: false });
            core.info(`Created PR #${pr.data.number}`);

            // Apply automerge label (merge still gated by required checks).
            await github.rest.issues.addLabels({ owner, repo, issue_number: pr.data.number, labels: [labelName] });
            core.info('Applied automerge label.');
